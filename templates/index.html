<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Chatbot Quolocstore</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
    }

    /* Ph·∫ßn t·ª≠ bao ch·ª©a bong b√≥ng chat v√† khung chat */
    #chat-wrapper {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      cursor: move; /* Cho bi·∫øt ph·∫ßn n√†y c√≥ th·ªÉ k√©o th·∫£ */
    }

    /* Bong b√≥ng chat */
    .chat-button {
      background: #0084ff;
      color: #fff;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      user-select: none;
    }

    /* Khung chat, ƒë∆∞·ª£c ƒë·∫∑t t∆∞∆°ng ƒë·ªëi so v·ªõi chat-wrapper */
    .chat-container {
      position: absolute;
      /* M·∫∑c ƒë·ªãnh: hi·ªÉn th·ªã ph√≠a tr√™n bong b√≥ng chat v·ªõi c·∫°nh ph·∫£i cƒÉn ch·ªânh */
      bottom: 70px;
      right: 0;
      width: 360px;
      height: 500px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      display: none;
      flex-direction: column;
      overflow: hidden;
      animation: fadeInUp 0.3s ease;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .chat-header {
      background: #0084ff;
      color: #fff;
      padding: 15px;
      text-align: center;
      font-size: 18px;
    }

    .chat-box {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background: #e5ddd5;
    }

    .message-container {
      display: flex;
      margin-bottom: 10px;
    }

    /* Style tin nh·∫Øn ng∆∞·ªùi d√πng */
    .message.user {
      justify-content: flex-end;
    }

    /* Style tin nh·∫Øn bot */
    .message.bot {
      justify-content: flex-start;
    }

    .bubble {
      max-width: 70%;
      padding: 10px 15px;
      border-radius: 20px;
      position: relative;
      line-height: 1.4;
      font-size: 14px;
      word-wrap: break-word;
    }

    .bubble.user {
      background: #0084ff;
      color: #fff;
      border-bottom-right-radius: 0;
    }

    .bubble.bot {
      background: #fff;
      color: #000;
      border: 1px solid #ccc;
      border-bottom-left-radius: 0;
    }

    .chat-footer {
      display: flex;
      border-top: 1px solid #ddd;
    }

    .chat-footer input {
      flex: 1;
      border: none;
      padding: 15px;
      font-size: 16px;
      outline: none;
    }

    .chat-footer button {
      background: #0084ff;
      border: none;
      padding: 15px 20px;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
    }

    .chat-footer button:hover {
      background: #006bbf;
    }
  </style>
</head>
<body>

  <!-- Ph·∫ßn t·ª≠ bao ch·ª©a bong b√≥ng chat v√† khung chat -->
  <div id="chat-wrapper">
    <!-- Khung chat -->
    <div class="chat-container" id="chat-container">
      <div class="chat-header">
        Chatbot Quolocstore
      </div>
      <div id="chat-box" class="chat-box">
        <!-- Tin nh·∫Øn s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
      </div>
      <div class="chat-footer">
        <input type="text" id="user-input" placeholder="Nh·∫≠p tin nh·∫Øn...">
        <button id="send-btn">G·ª≠i</button>
      </div>
    </div>
    <!-- Bong b√≥ng chat -->
    <div class="chat-button" id="chat-toggle">üí¨</div>
  </div>

  <script>
    // Bi·∫øn d√πng ƒë·ªÉ ph√¢n bi·ªát thao t√°c k√©o v√† click
    let isDragging = false;
    let startX, startY;
    let offsetX, offsetY;
    const dragThreshold = 5; // N·∫øu di chuy·ªÉn v∆∞·ª£t qu√° 5px th√¨ coi l√† k√©o

    const chatWrapper = document.getElementById("chat-wrapper");
    const chatToggle = document.getElementById("chat-toggle");
    const chatContainer = document.getElementById("chat-container");

    // Khi nh·∫•n chu·ªôt xu·ªëng trong chat-wrapper
    chatWrapper.addEventListener("mousedown", function(e) {
      isDragging = false;
      startX = e.clientX;
      startY = e.clientY;
      const rect = chatWrapper.getBoundingClientRect();
      offsetX = e.clientX - rect.left;
      offsetY = e.clientY - rect.top;

      document.addEventListener("mousemove", onMouseMove);
      document.addEventListener("mouseup", onMouseUp);
    });

    function onMouseMove(e) {
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      if (!isDragging && Math.sqrt(dx * dx + dy * dy) > dragThreshold) {
        isDragging = true;
      }
      if (isDragging) {
        let newX = e.clientX - offsetX;
        let newY = e.clientY - offsetY;

        // Gi·ªõi h·∫°n v·ªã tr√≠ di chuy·ªÉn ƒë·ªÉ kh√¥ng ra ngo√†i c·ª≠a s·ªï
        const margin = 10; // Kho·∫£ng c√°ch t·ªëi thi·ªÉu so v·ªõi c√°c vi·ªÅn m√†n h√¨nh
        const buttonWidth = chatToggle.offsetWidth;   // k√≠ch th∆∞·ªõc c·ªßa bong b√≥ng (60px)
        const buttonHeight = chatToggle.offsetHeight;   // t∆∞∆°ng t·ª±

        // Gi·ªõi h·∫°n theo chi·ªÅu ngang:
        newX = Math.max(margin, Math.min(newX, window.innerWidth - buttonWidth - margin));
        // Gi·ªõi h·∫°n theo chi·ªÅu d·ªçc:
        newY = Math.max(margin, Math.min(newY, window.innerHeight - buttonHeight - margin));

        chatWrapper.style.left = newX + "px";
        chatWrapper.style.top = newY + "px";
        // Khi s·ª≠ d·ª•ng left/top, v√¥ hi·ªáu h√≥a right/bottom
        chatWrapper.style.right = "auto";
        chatWrapper.style.bottom = "auto";
      }
    }

    function onMouseUp(e) {
      document.removeEventListener("mousemove", onMouseMove);
      document.removeEventListener("mouseup", onMouseUp);
    }

    // Khi nh·∫•p v√†o bong b√≥ng chat (n·∫øu kh√¥ng k√©o) th√¨ m·ªü/ƒë√≥ng khung chat,
    // ƒë·ªìng th·ªùi ƒëi·ªÅu ch·ªânh v·ªã tr√≠ hi·ªÉn th·ªã c·ªßa khung chat ƒë·ªÉ kh√¥ng b·ªã tr√†n ra ngo√†i c·ª≠a s·ªï.
    chatToggle.addEventListener("click", function(e) {
      if (isDragging) {
        e.preventDefault();
        return;
      }

      // K√≠ch th∆∞·ªõc c·ªë ƒë·ªãnh c·ªßa khung chat v√† bong b√≥ng chat
      const containerWidth = 360;
      const containerHeight = 500;
      const bubbleWidth = chatToggle.offsetWidth;  // 60px
      const bubbleHeight = chatToggle.offsetHeight;  // 60px

      // L·∫•y v·ªã tr√≠ hi·ªán t·∫°i c·ªßa chat-wrapper (v·ªã tr√≠ c·ªßa bong b√≥ng chat)
      const rect = chatWrapper.getBoundingClientRect();

      // --- X√©t v·ªã tr√≠ theo chi·ªÅu ngang ---
      const leftSpace = rect.left;
      const rightSpace = window.innerWidth - rect.right;

      if (leftSpace < (containerWidth - bubbleWidth)) {
        // N·∫øu kh√¥ng ƒë·ªß kh√¥ng gian b√™n tr√°i, hi·ªÉn th·ªã khung chat b√™n ph·∫£i c·ªßa bong b√≥ng
        chatContainer.style.left = "0";
        chatContainer.style.right = "auto";
      } else if (rightSpace < (containerWidth - bubbleWidth)) {
        // N·∫øu kh√¥ng ƒë·ªß kh√¥ng gian b√™n ph·∫£i, hi·ªÉn th·ªã khung chat b√™n tr√°i c·ªßa bong b√≥ng
        chatContainer.style.right = "0";
        chatContainer.style.left = "auto";
      } else {
        // N·∫øu ƒë·ªß kh√¥ng gian, gi·ªØ m·∫∑c ƒë·ªãnh (c·∫°nh ph·∫£i cƒÉn)
        chatContainer.style.right = "0";
        chatContainer.style.left = "auto";
      }

      // --- X√©t v·ªã tr√≠ theo chi·ªÅu d·ªçc ---
      if (rect.top < (containerHeight + 70)) {
        // N·∫øu qu√° s√°t ph√≠a tr√™n, hi·ªÉn th·ªã khung chat ph√≠a d∆∞·ªõi bong b√≥ng
        chatContainer.style.top = "70px";
        chatContainer.style.bottom = "auto";
      } else if (window.innerHeight - rect.bottom < (containerHeight + 70)) {
        // N·∫øu qu√° s√°t ph√≠a d∆∞·ªõi, hi·ªÉn th·ªã khung chat ph√≠a tr√™n bong b√≥ng
        chatContainer.style.bottom = "70px";
        chatContainer.style.top = "auto";
      } else {
        chatContainer.style.bottom = "70px";
        chatContainer.style.top = "auto";
      }

      // Hi·ªÉn th·ªã/·∫©n khung chat
      chatContainer.style.display = (chatContainer.style.display === "none" || !chatContainer.style.display) ? "flex" : "none";
    });

    // X·ª≠ l√Ω g·ª≠i tin nh·∫Øn trong khung chat
    const chatBox = document.getElementById("chat-box");
    const userInput = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");

    function addMessage(sender, message) {
      const container = document.createElement("div");
      container.classList.add("message-container", sender);

      const bubble = document.createElement("div");
      bubble.classList.add("bubble", sender);
      bubble.textContent = message;

      container.appendChild(bubble);
      chatBox.appendChild(container);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    sendBtn.addEventListener("click", function() {
      const message = userInput.value;
      if (!message.trim()) return;
      addMessage("user", message);
      userInput.value = "";

      // Gi·∫£ l·∫≠p g·ªçi API (thay ƒë·ªïi endpoint cho ph√π h·ª£p)
      fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: message })
      })
      .then(response => response.json())
      .then(data => {
        addMessage("bot", data.reply);
      })
      .catch(error => {
        addMessage("bot", "L·ªói: " + error);
      });
    });

    userInput.addEventListener("keyup", function(event) {
      if (event.key === "Enter") {
        sendBtn.click();
      }
    });
  </script>

</body>
</html>
